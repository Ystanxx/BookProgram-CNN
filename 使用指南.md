# 一维卷积神经网络拉曼谱图分析系统 - 使用指南

## 📋 目录
- [系统要求](#系统要求)
- [安装步骤](#安装步骤)
  - [方法一：Conda环境（推荐）](#方法一conda环境推荐)
  - [方法二：系统本地环境](#方法二系统本地环境)
- [使用流程](#使用流程)
  - [步骤1：快速测试](#步骤1快速测试)
  - [步骤2：训练模型](#步骤2训练模型)
  - [步骤3：使用模型预测](#步骤3使用模型预测)
- [配置说明](#配置说明)
- [常见问题](#常见问题)
- [项目文件说明](#项目文件说明)

---

## 系统要求

### 硬件要求
- **内存**：建议8GB以上
- **硬盘**：至少2GB可用空间
- **处理器**：支持SSE2指令集的CPU
- **GPU**：可选（当前默认CPU模式）

### 软件要求
- **操作系统**：Windows 10/11（64位）
- **Python版本**：3.8 - 3.11
- **网络连接**：安装依赖时需要

---

## 安装步骤

### 方法一：Conda环境（推荐）

**优点**：环境隔离，不影响系统Python，管理方便

#### 1.1 安装Anaconda或Miniconda

**下载地址**：
- Anaconda（完整版，约500MB）：https://www.anaconda.com/download
- Miniconda（精简版，约90MB，推荐）：https://docs.conda.io/en/latest/miniconda.html

**安装步骤**：
1. 下载Windows 64位安装程序
2. 双击运行安装程序
3. 选择"Just Me"（仅为当前用户）
4. 安装路径建议使用默认路径
5. 勾选"Add Miniconda to PATH"（可选，方便使用）
6. 完成安装

**验证安装**：
打开命令提示符（CMD）或Anaconda Prompt，输入：
```bash
conda --version
```
应显示类似：`conda 23.x.x`

#### 1.2 创建Python环境

打开Anaconda Prompt（或CMD），执行：

```bash
# 创建名为raman_cnn的环境，Python版本3.11
conda create -n raman_cnn python=3.11 -y
```

#### 1.3 激活环境

```bash
conda activate raman_cnn
```

**注意**：每次使用前都需要激活环境

#### 1.4 进入项目目录

```bash
cd /d "D:\你的路径\卷积神经网络（CNN）在特征局部模式识别中的优势"
```

**提示**：可以在文件夹中按住Shift键，右键点击空白处，选择"在此处打开PowerShell窗口"或"在此处打开命令窗口"

#### 1.5 安装依赖包

```bash
pip install -r requirements.txt
```

**如果下载慢，使用清华镜像源**：
```bash
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

#### 1.6 验证安装

```bash
python -c "import torch; print('PyTorch:', torch.__version__)"
python -c "import numpy; print('NumPy:', numpy.__version__)"
```

如果都能正常显示版本号，说明安装成功！

---

### 方法二：系统本地环境

**优点**：简单直接，不需要额外软件

#### 2.1 安装Python

**下载地址**：https://www.python.org/downloads/

1. 下载Python 3.11.x Windows安装程序（64位）
2. 运行安装程序
3. **重要**：勾选"Add Python to PATH"
4. 选择"Install Now"
5. 等待安装完成

**验证安装**：
打开命令提示符（CMD），输入：
```bash
python --version
```
应显示：`Python 3.11.x`

```bash
pip --version
```
应显示pip版本信息

#### 2.2 进入项目目录

```bash
cd /d "D:\你的路径\卷积神经网络（CNN）在特征局部模式识别中的优势"
```

#### 2.3 （可选）创建虚拟环境

虽然是本地安装，但建议使用虚拟环境隔离项目：

```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
venv\Scripts\activate
```

激活后，命令行前面会显示`(venv)`

#### 2.4 安装依赖包

```bash
pip install -r requirements.txt
```

**如果下载慢，使用清华镜像源**：
```bash
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

**常用国内镜像源**：
- 清华：https://pypi.tuna.tsinghua.edu.cn/simple
- 阿里：https://mirrors.aliyun.com/pypi/simple/
- 中科大：https://pypi.mirrors.ustc.edu.cn/simple/

#### 2.5 验证安装

```bash
python -c "import torch; print('PyTorch:', torch.__version__)"
python -c "import numpy; print('NumPy:', numpy.__version__)"
```

---

## 使用流程

### 步骤1：快速测试

**目的**：验证程序是否正常工作

**命令**：
```bash
python quick_start.py
```

**预期输出**：
```
配置加载完成，使用设备: cpu
================================================================================
拉曼谱图一维卷积神经网络分析系统 - 快速开始
================================================================================

1. 数据生成演示
   - 生成100个样本
   - 显示数据统计信息

2. 模型架构演示
   - 1D-CNN模型信息
   - 1D-ResNet18模型信息

3. 前向传播演示
   - 测试模型输入输出

4. 单样本预测演示
   - 演示预测流程

================================================================================
快速开始演示完成！
================================================================================
```

**如果出现错误**：
- 检查是否激活了conda环境（如使用conda）
- 检查是否在正确的项目目录
- 查看[常见问题](#常见问题)部分

---

### 步骤2：训练模型

#### 2.1 开始训练

**命令**：
```bash
python train.py
```

#### 2.2 训练过程说明

**第一阶段：数据准备**
```
正在生成 1000 个样本...
数据集已保存到 data/
```
- 自动生成1000个模拟拉曼谱图样本
- 首次运行会生成数据，后续运行会重用

**第二阶段：模型训练（五折交叉验证）**

程序会训练两个模型，每个模型5折：
1. 1D-CNN模型（5折）
2. 1D-ResNet18模型（5折）

**每折训练时会显示**：
```
================================================================================
开始训练 CNN 模型 - 折 1
================================================================================

Epoch [1/100]
--------------------------------------------------------------------------------
  Batch [10/16] | Loss: 2.3456 | Class: 1.2345 | Reg: 1.1111
  ...

训练 | Loss: 2.1234 | Class: 1.1234 | Reg: 1.0000
验证 | Loss: 2.0123 | Class: 1.0567 | Reg: 0.9556
验证 | Accuracy: 0.3500 | R²: 0.2345
时间: 1.2s | 学习率: 0.001000
✓ 保存最佳模型到: saved_models/cnn_1d_fold_0.pth
```

**说明**：
- `Loss`: 总损失（越小越好）
- `Class`: 分类损失
- `Reg`: 回归损失
- `Accuracy`: 分类准确率
- `R²`: 回归决定系数

#### 2.3 训练时间

| 阶段 | 预计时间 |
|------|---------|
| 数据生成 | < 1分钟 |
| CNN训练（5折） | 15-20分钟 |
| ResNet训练（5折） | 25-30分钟 |
| **总计** | **40-50分钟** |

**注意**：
- 训练期间可以继续使用电脑
- 请确保电脑不会进入睡眠模式
- CPU使用率会较高，属于正常现象

#### 2.4 训练完成

训练完成后会显示：
```
====================================================================================================
5折交叉验证平均结果:
====================================================================================================

分类指标:
  准确率: 0.8523 ± 0.0234
  F1分数: 0.8456

回归指标:
  R²: 0.9123 ± 0.0156
  MAE: 3.45
  RMSE: 4.78

结果已保存到: results/cnn_kfold_results.json
学习曲线已保存到: results/cnn_learning_curves.png
```

#### 2.5 训练输出文件

训练完成后，会生成以下文件：

```
saved_models/                    # 训练好的模型
├── cnn_1d_fold_0.pth
├── cnn_1d_fold_1.pth
├── cnn_1d_fold_2.pth
├── cnn_1d_fold_3.pth
├── cnn_1d_fold_4.pth
├── resnet_1d_fold_0.pth
├── resnet_1d_fold_1.pth
├── resnet_1d_fold_2.pth
├── resnet_1d_fold_3.pth
└── resnet_1d_fold_4.pth

results/                         # 训练结果
├── cnn_learning_curves.png      # CNN学习曲线图
├── cnn_kfold_results.json       # CNN性能报告
├── resnet_learning_curves.png   # ResNet学习曲线图
└── resnet_kfold_results.json    # ResNet性能报告

data/                            # 生成的数据
├── spectra.npy                  # 拉曼谱图数据
├── stages.npy                   # 发酵阶段标签
└── concentrations.npy           # 化学成分浓度
```

---

### 步骤3：使用模型预测

**前提**：必须先完成步骤2的模型训练

#### 3.1 运行预测脚本

**命令**：
```bash
python predict.py
```

#### 3.2 预测演示内容

**示例1：单个样本预测**
```
================================================================================
示例 1: 单个样本预测
================================================================================

真实标签:
  发酵阶段: 阶段7
  化学成分浓度: [73.93 63.67 77.59 ... ]

使用 1D-CNN 模型预测:
成功加载模型: saved_models/cnn_1d_fold_0.pth
模型训练轮数: 45
验证损失: 1.2345

预测结果
================================================================================
发酵阶段预测: 阶段7 (置信度: 87.34%)

各阶段概率分布:
  阶段1      | ████                                             2.34%
  阶段2      | ███                                              1.23%
  ...
  阶段7      | ████████████████████████████████████████████     87.34%

化学成分浓度预测 (mg/L):
--------------------------------------------------------------------------------
  儿茶素C                : 72.45 mg/L
  EGCG                :  62.34 mg/L
  咖啡因                 :  76.89 mg/L
  ...
================================================================================
```

**示例2：集成预测（多模型多折）**
```
================================================================================
示例 2: 集成预测 (多模型多折)
================================================================================

使用 2 个模型和 5 折进行集成预测...
✓ CNN Fold 1: 阶段 7, 置信度 85.23%
✓ CNN Fold 2: 阶段 7, 置信度 86.45%
✓ CNN Fold 3: 阶段 7, 置信度 88.12%
✓ CNN Fold 4: 阶段 7, 置信度 87.90%
✓ CNN Fold 5: 阶段 7, 置信度 86.78%
✓ RESNET Fold 1: 阶段 7, 置信度 89.34%
...

集成预测结果
================================================================================
发酵阶段: 阶段7 (置信度: 87.52%)

化学成分浓度 (mg/L):
--------------------------------------------------------------------------------
  儿茶素C                : 72.15 ±  1.23 mg/L
  EGCG                :  62.89 ±  0.98 mg/L
  ...
================================================================================
```

**示例3：测试集评估**
```
================================================================================
示例 3: 测试集评估
================================================================================

在测试集上评估 CNN 模型 (Fold 0)...
正在预测测试集...

============================================================
分类指标:
============================================================
准确率 (Accuracy):          0.8523
精确率 (Precision-Macro):   0.8456
召回率 (Recall-Macro):      0.8390
F1分数 (F1-Macro):          0.8423

============================================================
回归指标:
============================================================
平均绝对误差 (MAE):   3.45
均方根误差 (RMSE):     4.78
决定系数 (R²):         0.9123

每个化学成分的指标:
------------------------------------------------------------
儿茶素C                 | MAE: 3.21 | RMSE: 4.56 | R²: 0.915
EGCG                 | MAE: 3.45 | RMSE: 4.89 | R²: 0.923
...
============================================================
```

#### 3.3 使用自己的数据进行预测

**方法一：修改predict.py**

在`predict.py`的主函数中，替换测试数据：

```python
# 替换这部分代码
# from data.data_generator import RamanDataGenerator
# generator = RamanDataGenerator(num_samples=1)
# test_spectra, test_stages, test_concentrations = generator.generate_dataset()

# 改为加载您自己的数据
import numpy as np
your_spectrum = np.load('your_data.npy')  # 形状应为 (1015,)

# 使用模型预测
from predict import Predictor
predictor = Predictor(model_name='cnn', fold=0)
stage_pred, stage_prob, conc_pred = predictor.predict_single(your_spectrum)

# 查看结果
print(f"预测阶段: {stage_pred}")
print(f"浓度预测: {conc_pred}")
```

**方法二：编写自己的预测脚本**

```python
import numpy as np
import torch
import config
from predict import Predictor

# 加载您的拉曼谱图数据
your_data = np.load('your_raman_spectra.npy')  # 形状: (n_samples, 1015)

# 创建预测器（使用CNN模型的第0折）
predictor = Predictor(model_name='cnn', fold=0)

# 批量预测
stage_preds, stage_probs, conc_preds = predictor.predict_batch(your_data)

# 保存结果
np.save('predicted_stages.npy', stage_preds)
np.save('predicted_concentrations.npy', conc_preds)

print(f"预测完成！共处理 {len(your_data)} 个样本")
```

---

## 配置说明

所有配置项在 `config.py` 文件中。

### 常用配置项

#### 设备配置
```python
# 默认CPU模式（最稳定）
DEVICE_MODE = 'cpu'

# 如果想使用GPU（需要显卡支持）
DEVICE_MODE = 'auto'  # 自动检测
# 或
DEVICE_MODE = 'cuda'  # 强制GPU
```

#### 训练参数
```python
BATCH_SIZE = 32          # 批次大小，内存不足可改小（如16）
EPOCHS = 100             # 最大训练轮数，想快速测试可改小（如50）
LEARNING_RATE = 0.001    # 学习率
K_FOLDS = 5              # 交叉验证折数，可改为3加快训练
```

#### 数据配置
```python
DATA_CONFIG = {
    'num_samples': 1000,      # 样本数量，可改为更多或更少
    'noise_level': 0.05,      # 噪声水平
    'random_seed': 42,        # 随机种子，保证可重复性
}
```

#### 模型配置

**CNN配置**：
```python
CNN_CONFIG = {
    'conv_channels': [32, 64, 128, 256],  # 卷积层通道数
    'dropout_rate': 0.5,                   # Dropout比率
    'fc_hidden_dim': 512,                  # 全连接层维度
}
```

**ResNet配置**：
```python
RESNET_CONFIG = {
    'initial_channels': 64,                      # 初始通道数
    'block_channels': [64, 128, 256, 512],       # 各层通道数
    'dropout_rate': 0.5,
}
```

### 修改配置的方法

1. 打开 `config.py` 文件
2. 找到要修改的配置项
3. 修改数值
4. 保存文件
5. 重新运行程序

---

## 常见问题

### 安装相关

**Q1: pip install很慢怎么办？**

A: 使用国内镜像源：
```bash
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

**Q2: 提示"'python' 不是内部或外部命令"？**

A: Python未添加到PATH。解决方法：
- 重新安装Python，勾选"Add Python to PATH"
- 或使用完整路径：`C:\Python311\python.exe`
- 或使用Anaconda Prompt（如使用conda）

**Q3: conda命令不可用？**

A: 
- 使用"Anaconda Prompt"而不是普通CMD
- 或在安装时勾选"Add to PATH"

**Q4: 安装torch时出错？**

A: 
- 确保Python版本是3.8-3.11
- 尝试单独安装：`pip install torch`
- 检查网络连接

### 运行相关

**Q5: 运行时提示"No module named 'xxx'"？**

A: 某个依赖包未安装，手动安装：
```bash
pip install xxx
```

**Q6: 训练时内存不足？**

A: 在`config.py`中减小批次大小：
```python
BATCH_SIZE = 16  # 或更小，如8
```

**Q7: 想加快训练速度？**

A: 
- 减少训练轮数：`EPOCHS = 50`
- 减少折数：`K_FOLDS = 3`
- 使用GPU（如果支持）

**Q8: GPU不可用怎么办？**

A: 
- 使用默认CPU模式即可
- CPU模式完全可用，只是慢一些
- 40-50分钟可以完成训练

**Q9: 训练中途中断了怎么办？**

A: 
- 重新运行`python train.py`会从头开始
- 之前保存的最佳模型会被覆盖
- 建议备份`saved_models`文件夹

**Q10: 如何查看训练进度？**

A: 
- 观察命令行输出的Loss值
- Loss逐渐下降说明训练正常
- 每个epoch结束会显示验证结果

### 使用相关

**Q11: 如何使用自己的拉曼谱图数据？**

A: 
1. 将数据整理成numpy数组，形状为`(n_samples, 1015)`
2. 修改`data/data_generator.py`或创建新的加载函数
3. 或直接使用训练好的模型进行预测

**Q12: 预测结果不准确？**

A: 
- 当前使用的是模拟数据，准确率有限
- 使用真实数据重新训练可提高准确率
- 增加训练样本数量
- 调整模型参数

**Q13: 可以只训练一个模型吗？**

A: 可以，修改`train.py`：
```python
# 只训练CNN
cnn_results = train_with_k_fold(model_name='cnn', k_folds=5)

# 注释掉ResNet训练部分
# resnet_results = train_with_k_fold(model_name='resnet', k_folds=5)
```

**Q14: 如何使用英文标签？**

A: 在`config.py`中修改：
```python
CLASS_NAMES = [
    "Stage1", "Stage2", ..., "Stage10"
]
TARGET_NAMES = [
    "Catechin", "EGCG", "Caffeine", ...
]
```

### 错误排查

**Q15: 出现编码错误？**

A: 在命令行执行：
```bash
chcp 65001
```
然后重新运行程序

**Q16: matplotlib显示警告？**

A: 可以忽略，不影响功能。或安装中文字体。

**Q17: 程序卡住不动？**

A: 
- 检查是否在计算中（CPU使用率高）
- 等待一段时间（训练需要时间）
- 如果真的卡住，按Ctrl+C中断

---

## 项目文件说明

### 核心程序文件

```
config.py              # 配置文件，所有参数设置
train.py               # 训练脚本，运行此文件开始训练
predict.py             # 预测脚本，使用训练好的模型进行预测
quick_start.py         # 快速演示脚本，测试程序是否正常
```

### 模型定义文件

```
models/
  ├── cnn_1d.py        # 1D-CNN模型定义
  └── resnet_1d.py     # 1D-ResNet18模型定义
```

### 数据处理文件

```
data/
  └── data_generator.py    # 数据生成器，生成模拟拉曼谱图
```

### 工具函数文件

```
utils/
  ├── dataset.py       # PyTorch数据集类，处理数据加载
  └── metrics.py       # 评估指标计算，计算准确率、R²等
```

### 配置和文档

```
requirements.txt       # Python依赖包列表
使用指南.md            # 本文件，完整的使用说明
README.md             # 项目简介（简化版）
```

### 运行时生成的文件

```
data/                  # 生成的数据文件
  ├── spectra.npy
  ├── stages.npy
  └── concentrations.npy

saved_models/          # 训练好的模型文件
  ├── cnn_1d_fold_*.pth
  └── resnet_1d_fold_*.pth

results/               # 训练结果和图表
  ├── *_learning_curves.png
  └── *_kfold_results.json

logs/                  # 日志文件（可选）
```

---

## 快速命令参考

### Conda环境

```bash
# 创建环境
conda create -n raman_cnn python=3.11 -y

# 激活环境
conda activate raman_cnn

# 安装依赖
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 退出环境
conda deactivate

# 删除环境
conda remove -n raman_cnn --all
```

### 本地环境

```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 退出虚拟环境
deactivate
```

### 运行程序

```bash
# 快速测试
python quick_start.py

# 训练模型
python train.py

# 使用模型预测
python predict.py
```

---

## 技术支持

如遇到问题：
1. 首先查看本文档的[常见问题](#常见问题)部分
2. 检查Python和依赖包是否正确安装
3. 查看命令行的错误提示信息
4. 检查`config.py`中的配置是否正确

---

**版本**: v1.0.0  
**更新日期**: 2025年10月26日  

**祝您使用愉快！** 🎉

